(()=>{"use strict";var e,t,r,l,s,n={51(e,t,r){var l=r(70),s=r(758),n=r(576),a=r(858),i=r(238),o=r(878);async function c(){let e=new Promise((e,t)=>{setTimeout(()=>t(Error("SDK 初始化超时")),3e3)}),t=o.UV.base.getSelection();return await Promise.race([t,e]),o.UV}async function d(e){let t=await fetch(e);return await t.text()}let u=e=>{var t,r;let{files:n,setFiles:o,isInBitable:c}=e,[u,x]=(0,s.useState)(null),[m,p]=(0,s.useState)(""),[f,h]=(0,s.useState)(!1),[b,g]=(0,s.useState)(null),j=(0,s.useRef)(null),v=(0,s.useRef)(null),y=(0,s.useRef)(new Map),N=async e=>{let t=e.target.files;if(!t||0===t.length)return;let r=[];for(let e of(y.current.clear(),Array.from(t))){let t=e.name.toLowerCase();if(t.endsWith(".jsx")||t.endsWith(".tsx")){let t=await e.text(),l=`local-${Date.now()}-${e.name}`;y.current.set(l,t),r.push({name:e.name,url:"",token:l,type:e.type})}}o(r),v.current&&(v.current.value="")},w=function(e){let t=e.filter(e=>"App.tsx"===e.name||"App.jsx"===e.name);if(0===t.length)return{valid:!1,error:"缺少入口文件：请上传 App.tsx 或 App.jsx 文件"};if(t.length>1){let e=t.some(e=>"App.tsx"===e.name),r=t.some(e=>"App.jsx"===e.name);return e&&r?{valid:!1,error:"入口文件冲突：不能同时存在 App.tsx 和 App.jsx，请只保留一个"}:{valid:!1,error:`发现多个入口文件：${t.map(e=>e.name).join(", ")}，请只保留一个`}}return{valid:!0,appFile:t[0]}}(n);(0,s.useEffect)(()=>{if(n.length>0&&w.valid&&w.appFile){let e=w.appFile;((null==u?void 0:u.token)!==e.token||(null==u?void 0:u.url)!==e.url)&&x(e)}else x(null),p("")},[n,w.valid,null==(t=w.appFile)?void 0:t.token,null==(r=w.appFile)?void 0:r.url]);let k=(0,s.useRef)("");return((0,s.useEffect)(()=>{if(!u){k.current="";return}u.token===k.current||(async()=>{try{let e;h(!0),g(null),e=u.token.startsWith("local-")?y.current.get(u.token)||"":await d(u.url),p(e),k.current=u.token}catch(e){g(e instanceof Error?e.message:"加载失败")}finally{h(!1)}})()},[u]),(0,s.useEffect)(()=>()=>{j.current&&!j.current.closed&&j.current.close()},[]),0===n.length)?(0,l.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[(0,l.jsx)("input",{ref:v,type:"file",accept:".tsx,.jsx",onChange:N,className:"hidden"}),c?(0,l.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-gray-300 gap-2",children:[(0,l.jsx)("div",{className:"text-5xl mb-2",children:"\uD83D\uDCCE"}),(0,l.jsx)("h3",{className:"text-base font-semibold text-gray-800",children:"请选择附件字段"}),(0,l.jsx)("p",{className:"text-sm text-gray-500",children:"选择包含 App.tsx 或 App.jsx 文件的附件单元格"})]}):(0,l.jsxs)("div",{onClick:()=>{var e;return null==(e=v.current)?void 0:e.click()},className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-gray-300 gap-2 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors",children:[(0,l.jsx)("div",{className:"text-5xl mb-2",children:"\uD83D\uDCE4"}),(0,l.jsx)("h3",{className:"text-base font-semibold text-gray-800",children:"点击上传文件"}),(0,l.jsx)("p",{className:"text-sm text-gray-500",children:"支持 App.tsx 或 App.jsx 文件"})]})]}):w.valid?(0,l.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[b&&(0,l.jsx)("div",{className:"px-3 py-2.5 bg-red-50 border border-red-200 rounded-md text-sm text-red-600",children:b}),(0,l.jsx)("button",{onClick:()=>{if(!m||!u)return;j.current&&!j.current.closed&&j.current.close();let e=`preview-${Date.now()}`,t=JSON.stringify({code:m,fileName:u.name});localStorage.setItem(e,t);let r=new URL("./preview.html",window.location.href).href+"#"+e;j.current=window.open(r,"react-preview","width=1200,height=800")},disabled:!m||f,className:"w-full py-3 text-base font-medium text-white bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed rounded-lg cursor-pointer transition-colors flex items-center justify-center gap-2",children:f?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"正在加载..."]}):(0,l.jsx)(l.Fragment,{children:"\uD83D\uDE80 在新窗口预览"})}),(0,l.jsxs)("div",{className:"px-4 py-3 bg-blue-50 border border-blue-200 rounded-md",children:[(0,l.jsx)("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"使用说明"}),(0,l.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1 list-disc list-inside",children:[(0,l.jsx)("li",{children:"附件中必须包含 App.tsx 或 App.jsx 作为入口"}),(0,l.jsx)("li",{children:"目前只支持单文件组件，不支持文件间引用"}),(0,l.jsx)("li",{children:"请确保额外依赖都在组件顶部通过 import 引入"}),(0,l.jsx)("li",{children:"首次打开需要等待环境初始化（约30秒）"})]}),(0,l.jsx)("h4",{className:"text-sm font-medium text-blue-800 mt-3 mb-2",children:"预装依赖"}),(0,l.jsx)("div",{className:"flex flex-wrap gap-1.5",children:["react","react-dom","tailwindcss"].map(e=>(0,l.jsx)("span",{className:"px-2 py-0.5 text-xs font-mono bg-blue-100 text-blue-700 rounded",children:e},e))}),(0,l.jsx)("p",{className:"text-xs text-blue-600 mt-2",children:"其他依赖会根据代码中的 import 自动安装"})]}),m&&!f&&(0,l.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden flex flex-col flex-1",children:[(0,l.jsx)("div",{className:"flex items-center px-3 py-2 bg-gray-100 border-b border-gray-200",children:(0,l.jsxs)("span",{className:"text-sm font-medium text-gray-800",children:["\uD83D\uDCC4 ",null==u?void 0:u.name]})}),(0,l.jsx)("div",{className:"flex-1 overflow-auto",children:(0,l.jsx)(a.A,{language:(null==u?void 0:u.name.endsWith(".tsx"))?"tsx":"jsx",style:i.A,customStyle:{margin:0,padding:"12px",fontSize:"12px",lineHeight:"1.5",minHeight:"100%"},showLineNumbers:!0,children:m})})]})]}):(0,l.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[(0,l.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-red-300 gap-2",children:[(0,l.jsx)("div",{className:"text-5xl mb-2",children:"⚠️"}),(0,l.jsx)("h3",{className:"text-base font-semibold text-red-600",children:"文件验证失败"}),(0,l.jsx)("p",{className:"text-sm text-red-500 max-w-[280px]",children:w.error})]}),(0,l.jsxs)("div",{className:"px-4 py-3 bg-gray-50 border border-gray-200 rounded-md",children:[(0,l.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"当前附件文件："}),(0,l.jsx)("ul",{className:"text-sm text-gray-600 space-y-1",children:n.map(e=>(0,l.jsx)("li",{className:"flex items-center gap-2",children:(0,l.jsxs)("span",{className:"App.tsx"===e.name||"App.jsx"===e.name?"text-red-500 font-medium":"",children:["\uD83D\uDCC4 ",e.name]})},e.token))})]}),(0,l.jsxs)("div",{className:"px-4 py-3 bg-blue-50 border border-blue-200 rounded-md",children:[(0,l.jsx)("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"文件要求"}),(0,l.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1 list-disc list-inside",children:[(0,l.jsx)("li",{children:"必须包含一个 App.tsx 或 App.jsx 作为入口文件"}),(0,l.jsx)("li",{children:"不能同时存在 App.tsx 和 App.jsx"}),(0,l.jsx)("li",{children:"入口文件必须导出一个 React 组件"})]})]})]})},x=document.getElementById("root");x&&n.createRoot(x).render((0,l.jsx)(s.StrictMode,{children:(0,l.jsx)(()=>{let[e,t]=(0,s.useState)([]),[r,n]=(0,s.useState)(!1),[a,i]=(0,s.useState)(!0);return((0,s.useEffect)(()=>{(async()=>{try{await c(),n(!0),i(!0),function(e){let t=null,r="",l=null;async function s(e,t,r){try{let l=await o.UV.base.getTableById(e),s=await l.getFieldById(r),n=await s.getType();if(17!==n)return[];let a=await s.getValue(t);if(!a||0===a.length)return[];let i=a.filter(e=>{let t=e.name.toLowerCase();return t.endsWith(".jsx")||t.endsWith(".tsx")});if(0===i.length)return[];let c=await s.getAttachmentUrls(t),d=new Map;return c.forEach((e,t)=>{a[t]&&d.set(a[t].token,e)}),i.map(e=>({name:e.name,url:d.get(e.token)||"",token:e.token,type:e.type}))}catch(e){return console.error("[Bitable] Error reading attachment field:",e),[]}}function n(e){return e.map(e=>`${e.token}:${e.name}`).sort().join("|")}async function a(){if(!t)return;let{tableId:l,recordId:a,fieldId:i}=t,o=await s(l,a,i),c=n(o);c!==r&&(console.log("[Bitable] Files changed:",o.map(e=>e.name)),r=c,e(o))}function i(){l&&(clearInterval(l),l=null)}o.UV.base.onSelectionChange(async o=>{let{fieldId:c,recordId:d,tableId:u}=o.data;if(console.log("[Bitable] Selection changed:",{fieldId:c,recordId:d,tableId:u}),!c||!d||!u){console.log("[Bitable] Missing selection data, clearing"),t=null,r="",i(),e([]);return}t={tableId:u,recordId:d,fieldId:c};let x=await s(u,d,c),m=n(x);console.log("[Bitable] Files:",x.map(e=>e.name)),r=m,e(x),i(),l=setInterval(a,2e3)})}(e=>{console.log("[App] Received files:",e.map(e=>e.name)),t(e)})}catch(e){console.error("Failed to initialize Bitable SDK:",e),i(!1),n(!0)}})()},[]),r)?(0,l.jsxs)("div",{className:"flex flex-col min-h-screen p-4 bg-gray-100 font-sans",children:[(0,l.jsx)("header",{className:"mb-4",children:(0,l.jsx)("p",{className:"text-sm text-gray-500",children:a?"选择附件字段中的 JSX/TSX 文件进行实时预览":"上传 JSX/TSX 文件进行实时预览"})}),(0,l.jsx)("main",{className:"flex-1 flex flex-col",children:(0,l.jsx)(u,{files:e,setFiles:t,isInBitable:a})})]}):(0,l.jsx)("div",{className:"flex flex-col min-h-screen p-4 bg-gray-100 font-sans",children:(0,l.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] gap-4",children:[(0,l.jsx)("div",{className:"w-8 h-8 border-3 border-gray-200 border-t-blue-500 rounded-full animate-spin"}),(0,l.jsx)("p",{className:"text-sm text-gray-500",children:"正在初始化..."})]})})},{})}))}},a={};function i(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={exports:{}};return n[e](r,r.exports,i),r.exports}i.m=n,i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce((t,r)=>(i.f[r](e,t),t),[])),i.u=e=>"static/js/async/"+e+".925ccc17.js",i.miniCssF=e=>""+e+".css",i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},i.l=function(t,r,l,s){if(e[t])return void e[t].push(r);if(void 0!==l)for(var n,a,o=document.getElementsByTagName("script"),c=0;c<o.length;c++){var d=o[c];if(d.getAttribute("src")==t||d.getAttribute("data-rspack")=="lark-codesandbox-plugin:"+l){n=d;break}}n||(a=!0,(n=document.createElement("script")).timeout=120,i.nc&&n.setAttribute("nonce",i.nc),n.setAttribute("data-rspack","lark-codesandbox-plugin:"+l),n.src=t),e[t]=[r];var u=function(r,l){n.onerror=n.onload=null,clearTimeout(x);var s=e[t];if(delete e[t],n.parentNode&&n.parentNode.removeChild(n),s&&s.forEach(function(e){return e(l)}),r)return r(l)},x=setTimeout(u.bind(null,void 0,{type:"timeout",target:n}),12e4);n.onerror=u.bind(null,n.onerror),n.onload=u.bind(null,n.onload),a&&document.head.appendChild(n)},i.r=e=>{"u">typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.nc=void 0,t=[],i.O=(e,r,l,s)=>{if(r){s=s||0;for(var n=t.length;n>0&&t[n-1][2]>s;n--)t[n]=t[n-1];t[n]=[r,l,s];return}for(var a=1/0,n=0;n<t.length;n++){for(var[r,l,s]=t[n],o=!0,c=0;c<r.length;c++)(!1&s||a>=s)&&Object.keys(i.O).every(e=>i.O[e](r[c]))?r.splice(c--,1):(o=!1,s<a&&(a=s));if(o){t.splice(n--,1);var d=l();void 0!==d&&(e=d)}}return e},i.p="./",r={410:0,649:0},i.f.j=function(e,t){var l=i.o(r,e)?r[e]:void 0;if(0!==l)if(l)t.push(l[2]);else if(649!=e){var s=new Promise((t,s)=>l=r[e]=[t,s]);t.push(l[2]=s);var n=i.p+i.u(e),a=Error();i.l(n,function(t){if(i.o(r,e)&&(0!==(l=r[e])&&(r[e]=void 0),l)){var s=t&&("load"===t.type?"missing":t.type),n=t&&t.target&&t.target.src;a.message="Loading chunk "+e+" failed.\n("+s+": "+n+")",a.name="ChunkLoadError",a.type=s,a.request=n,l[1](a)}},"chunk-"+e,e)}else r[e]=0},i.O.j=e=>0===r[e],l=(e,t)=>{var l,s,[n,a,o]=t,c=0;if(n.some(e=>0!==r[e])){for(l in a)i.o(a,l)&&(i.m[l]=a[l]);if(o)var d=o(i)}for(e&&e(t);c<n.length;c++)s=n[c],i.o(r,s)&&r[s]&&r[s][0](),r[s]=0;return i.O(d)},(s=self.webpackChunklark_codesandbox_plugin=self.webpackChunklark_codesandbox_plugin||[]).forEach(l.bind(null,0)),s.push=l.bind(null,s.push.bind(s));var o=i.O(void 0,["783","449","649"],()=>i(51));o=i.O(o)})();