(()=>{"use strict";var e,t,r,n,l={596(e,t,r){var n=r(70),l=r(758),s=r(576),a=r(305),i=r(809),o=r(627);r(382);let c="cache",d=".local/share/pnpm/store";function u(){return new Promise((e,t)=>{let r=indexedDB.open("pnpm-store-cache",6);r.onerror=()=>t(r.error),r.onsuccess=()=>e(r.result),r.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains("files")&&t.deleteObjectStore("files"),t.objectStoreNames.contains("cache")&&t.deleteObjectStore("cache"),t.createObjectStore(c)}})}async function p(e){let t=new Blob([e]).stream().pipeThrough(new CompressionStream("gzip")),r=[],n=t.getReader();for(;;){let{done:e,value:t}=await n.read();if(e)break;r.push(t)}let l=new Uint8Array(r.reduce((e,t)=>e+t.length,0)),s=0;for(let e of r)l.set(e,s),s+=e.length;return l}async function f(e){let t=new Blob([e]).stream().pipeThrough(new DecompressionStream("gzip")),r=[],n=t.getReader();for(;;){let{done:e,value:t}=await n.read();if(e)break;r.push(t)}let l=new Uint8Array(r.reduce((e,t)=>e+t.length,0)),s=0;for(let e of r)l.set(e,s),s+=e.length;return l}async function m(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=[];try{for(let l of(await e.fs.readdir(t,{withFileTypes:!0}))){let s=t+"/"+l.name,a=r?r+"/"+l.name:l.name;if(l.isDirectory()){let t=await m(e,s,a);n.push(...t)}else if(l.isFile())try{let t=await e.fs.readFile(s);n.push({path:a,contents:t})}catch{}}}catch{}return n}async function x(e,t){null==t||t("开始保存 pnpm store 缓存..."),null==t||t(`pnpm store 路径: ${d}`),null==t||t("正在读取 pnpm store 文件...");let r=await m(e,d);if(0===r.length){null==t||t("没有找到需要缓存的文件");return}null==t||t(`读取到 ${r.length} 个文件，正在序列化...`);let n=function(e){let t=new TextEncoder,r=4;for(let n of e)r+=4+t.encode(n.path).length+4+n.contents.length;let n=new Uint8Array(r),l=new DataView(n.buffer),s=0;for(let r of(l.setUint32(s,e.length,!0),s+=4,e)){let e=t.encode(r.path);l.setUint32(s,e.length,!0),s+=4,n.set(e,s),s+=e.length,l.setUint32(s,r.contents.length,!0),s+=4,n.set(r.contents,s),s+=r.contents.length}return n}(r);null==t||t(`序列化完成 (${(n.length/1024/1024).toFixed(2)}MB)，正在压缩...`);let l=await p(n),s=((1-l.length/n.length)*100).toFixed(1);null==t||t(`压缩完成: ${(n.length/1024/1024).toFixed(2)}MB -> ${(l.length/1024/1024).toFixed(2)}MB (节省 ${s}%)`),null==t||t("正在保存到 IndexedDB...");let a=await u(),i=a.transaction(c,"readwrite"),o=i.objectStore(c);await new Promise((e,t)=>{let r=o.put(l,"pnpm-store");r.onsuccess=()=>e(),r.onerror=()=>t(r.error)}),await new Promise((e,t)=>{i.oncomplete=()=>e(),i.onerror=()=>t(i.error)}),a.close(),null==t||t(`已缓存 ${r.length} 个文件`)}async function h(e,t){let r=[],n=0;async function l(){for(;n<e.length;){let t=n++;r[t]=await e[t]()}}let s=Array(Math.min(t,e.length)).fill(null).map(()=>l());return await Promise.all(s),r}async function g(e,t){null==t||t("正在检查 pnpm store 缓存...");let r=await u(),n=r.transaction(c,"readonly").objectStore(c),l=await new Promise((e,t)=>{let r=n.get("pnpm-store");r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)});if(r.close(),!l)return null==t||t("没有找到缓存"),!1;null==t||t(`找到缓存 (${(l.length/1024/1024).toFixed(2)}MB)，正在解压...`);let s=function(e){let t=new TextDecoder,r=new DataView(e.buffer,e.byteOffset,e.byteLength),n=[],l=0,s=r.getUint32(l,!0);l+=4;for(let a=0;a<s;a++){let s=r.getUint32(l,!0);l+=4;let a=e.slice(l,l+s),i=t.decode(a);l+=s;let o=r.getUint32(l,!0);l+=4;let c=e.slice(l,l+o);l+=o,n.push({path:i,contents:c})}return n}(await f(l));null==t||t(`正在恢复 ${s.length} 个缓存文件...`);let a=new Set;for(let e of s){let t=e.path.split("/"),r=d;for(let e=0;e<t.length-1;e++)r+="/"+t[e],a.add(r)}for(let t of Array.from(a).sort((e,t)=>e.split("/").length-t.split("/").length))try{await e.fs.mkdir(t,{recursive:!0})}catch{}let i=s.map(t=>async()=>{let r=`${d}/${t.path}`;await e.fs.writeFile(r,t.contents)});return await h(i,50),null==t||t(`已恢复 ${s.length} 个缓存文件`),!0}let b=null,w=!1;async function y(){if(b)return b;if(w){for(;w;)await new Promise(e=>setTimeout(e,100));if(b)return b}w=!0;try{return b=await a.iM.boot()}finally{w=!1}}let j=["react","react-dom","react/jsx-runtime","tailwindcss","postcss","autoprefixer"],v=["react","react-dom","tailwindcss"],N=null;s.createRoot(document.getElementById("root")).render((0,n.jsx)(l.StrictMode,{children:(0,n.jsx)(()=>{let[e,t]=(0,l.useState)("idle"),[r,s]=(0,l.useState)("等待接收代码..."),[a,c]=(0,l.useState)([]),[d,u]=(0,l.useState)(null),[p,f]=(0,l.useState)(null),[m,h]=(0,l.useState)(!1),[b,w]=(0,l.useState)(""),[S,$]=(0,l.useState)(!1),k=(0,l.useRef)(null),C=(0,l.useRef)(null),O=(0,l.useRef)(null),R=(0,l.useRef)(null),F=(0,l.useRef)(null),B=(0,l.useRef)(!1),E=(0,l.useRef)(null),M=(0,l.useCallback)(e=>{N&&(N.write(e.replace(/\n/g,"\r\n")),N.scrollToBottom())},[]),T=(0,l.useCallback)((e,r)=>{t(e),s(r)},[]),W=(0,l.useCallback)(e=>{c(t=>t.map(t=>({...t,status:e})))},[]),D=(0,l.useCallback)(()=>{E.current&&(E.current.src=E.current.src)},[]),U=(0,l.useCallback)(async e=>{let t=await e.spawn("jsh",{terminal:{cols:(null==N?void 0:N.cols)||80,rows:(null==N?void 0:N.rows)||24}});return t.output.pipeTo(new WritableStream({write:e=>{N&&N.write(e)}})),F.current=t.input.getWriter(),$(!0),t},[]),P=(0,l.useCallback)(()=>{F.current&&b.trim()&&(F.current.write(b+"\n"),w(""))},[b]);(0,l.useEffect)(()=>{if(!k.current||N)return;let e=new i.Terminal({theme:{background:"#1e1e1e",foreground:"#d4d4d4",cursor:"#d4d4d4"},fontSize:13,fontFamily:"'SF Mono', 'Fira Code', Consolas, monospace",cursorBlink:!1,disableStdin:!0}),t=new o.Y;e.loadAddon(t),e.open(k.current),t.fit(),N=e,O.current=t,h(!0);let r=()=>t.fit();return window.addEventListener("resize",r),()=>{window.removeEventListener("resize",r),e.dispose(),N=null}},[]),(0,l.useEffect)(()=>{if(!m||B.current)return;B.current=!0;let e=function(){let e=window.location.hash;if(!e||e.length<2)return null;try{let t=e.substring(1),r=decodeURIComponent(escape(atob(t)));return JSON.parse(r)}catch(e){return console.error("Failed to decode hash:",e),null}}();if(!e||!e.code){f("未能接收到代码，请关闭此窗口并重新点击预览按钮"),T("error","未收到代码");return}M(`收到代码: ${e.fileName}

`),A(e.code,e.fileName)},[m]);let A=async(e,t)=>{T("booting","正在分析依赖...");let r=function(e){let t,r=new Set,n=/import\s+(?:[\w\s{},*]+\s+from\s+)?['"]([^'"./][^'"]*)['"]/g;for(;null!==(t=n.exec(e));){let e=t[1];if(e.startsWith("@")){let t=e.split("/");e=t[0]+"/"+t[1]}else e=e.split("/")[0];r.add(e)}let l=/require\s*\(\s*['"]([^'"./][^'"]*)['"]\s*\)/g;for(;null!==(t=l.exec(e));){let e=t[1];if(e.startsWith("@")){let t=e.split("/");e=t[0]+"/"+t[1]}else e=e.split("/")[0];r.add(e)}return Array.from(r).filter(e=>!j.includes(e))}(e),n=[...v,...r];if(M("分析代码依赖...\n"),M(`默认依赖: ${v.join(", ")}
`),r.length>0&&M(`额外依赖: ${r.join(", ")}
`),M("\n"),c(n.map(e=>({name:e,status:"pending"}))),!window.crossOriginIsolated&&(T("booting","等待跨域隔离环境..."),await new Promise(e=>setTimeout(e,2e3)),!window.crossOriginIsolated)){f("浏览器环境不支持 WebContainers，请刷新页面重试"),T("error","环境不支持");return}try{let n,l,s,a,i,o,c,d,p;T("booting","正在启动 WebContainer..."),M("启动 WebContainer...\n");let f=await y();R.current=f,M("WebContainer 已启动\n\n"),T("booting","正在清理旧文件...");try{for(let e of(await f.fs.readdir("/")))await f.fs.rm(`/${e}`,{recursive:!0})}catch{}let{files:m}=(n=t.endsWith(".tsx"),l=t.replace(/\.(jsx|tsx)$/,""),s={react:"^18.2.0","react-dom":"^18.2.0"},r.forEach(e=>{s[e]="latest"}),a={"@rsbuild/core":"^1.0.0","@rsbuild/plugin-react":"^1.0.0","@rspack/binding-wasm32-wasi":"^1.0.0",tailwindcss:"^3.4.0",postcss:"^8.4.0",autoprefixer:"^10.4.0",...n?{typescript:"^5.3.0","@types/react":"^18.2.0","@types/react-dom":"^18.2.0"}:{}},i=`import { defineConfig } from '@rsbuild/core';
import { pluginReact } from '@rsbuild/plugin-react';

export default defineConfig({
  plugins: [pluginReact()],
});`,o=`/** @type {import('tailwindcss').Config} */
export default {
  content: ['./src/**/*.{js,jsx,ts,tsx}'],
  theme: {
    extend: {},
  },
  plugins: [],
};`,c=`export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};`,d=`@tailwind base;
@tailwind components;
@tailwind utilities;`,p=`import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css';
import ${l} from './${t}';

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <${l} />
  </React.StrictMode>
);`,{files:{"package.json":{file:{contents:JSON.stringify({name:"react-preview",type:"module",scripts:{dev:"rsbuild dev"},dependencies:s,devDependencies:a},null,2)}},".npmrc":{file:{contents:"store-dir=.local/share/pnpm/store"}},"rsbuild.config.mjs":{file:{contents:i}},"tailwind.config.js":{file:{contents:o}},"postcss.config.mjs":{file:{contents:c}},src:{directory:{"index.tsx":{file:{contents:p}},"index.css":{file:{contents:d}},[t]:{file:{contents:e}}}}}});T("booting","正在创建项目文件..."),await f.mount(m),M("项目文件已创建\n\n"),await g(f,e=>{M(e+"\n")})&&M("\n"),T("installing","正在安装依赖..."),W("installing"),M("$ pnpm install\n");let h=await f.spawn("pnpm",["install"]);h.output.pipeTo(new WritableStream({write:e=>M(e)}));let b=await h.exit;if(0!==b)throw Error("依赖安装失败");W("installed"),M("\n"),x(f,e=>{console.log("[缓存]",e)}).catch(e=>{console.error("保存 pnpm store 缓存失败:",e)}),T("running","正在启动开发服务器..."),M("$ pnpm run dev\n"),(await f.spawn("pnpm",["run","dev"])).output.pipeTo(new WritableStream({write:e=>M(e)})),f.on("server-ready",async(e,t)=>{T("running","开发服务器已启动"),u(t),await U(f)})}catch(e){console.error(e),f(e instanceof Error?e.message:"启动失败"),T("error","启动失败")}};return(0,n.jsxs)("div",{className:"flex flex-col min-h-screen bg-[#1e1e1e] text-white font-sans",children:[(0,n.jsxs)("header",{className:"flex items-center gap-3 px-4 py-3 bg-[#2d2d2d] border-b border-[#404040]",children:[(0,n.jsx)("h1",{className:"text-sm font-medium",children:"React 组件预览"}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-400",children:[(0,n.jsx)("div",{className:`w-2 h-2 rounded-full ${(()=>{switch(e){case"booting":case"installing":return"bg-amber-500";case"running":return"bg-emerald-500";case"error":return"bg-red-500";default:return"bg-gray-500"}})()}`}),(0,n.jsx)("span",{children:r})]})]}),(0,n.jsxs)("main",{className:"flex flex-1 min-h-0",children:[(0,n.jsxs)("div",{className:"w-[400px] flex flex-col bg-[#1e1e1e] border-r border-[#404040]",children:[(0,n.jsxs)("div",{className:"border-b border-[#404040]",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 bg-[#2d2d2d] border-b border-[#404040]",children:[(0,n.jsx)("span",{className:"text-xs text-gray-400",children:"\uD83D\uDCE6 依赖"}),(0,n.jsx)("span",{className:"px-2 py-0.5 text-[10px] bg-blue-500 text-white rounded-full",children:a.length})]}),(0,n.jsx)("div",{className:"px-3 py-2 max-h-[150px] overflow-auto",children:0===a.length?(0,n.jsx)("div",{className:"text-xs text-gray-500",children:"没有额外依赖"}):a.map(e=>(0,n.jsxs)("div",{className:"flex items-center gap-2 py-1 text-xs font-mono",children:[(0,n.jsx)("span",{className:"text-blue-400",children:e.name}),(0,n.jsx)("span",{className:`ml-auto px-2 py-0.5 rounded text-[10px] ${(e=>{switch(e){case"pending":return"bg-gray-700 text-gray-400";case"installing":return"bg-amber-900 text-amber-400";case"installed":return"bg-emerald-900 text-emerald-400"}})(e.status)}`,children:(e=>{switch(e){case"pending":return"待安装";case"installing":return"安装中";case"installed":return"已安装"}})(e.status)})]},e.name))})]}),(0,n.jsxs)("div",{className:"flex flex-col flex-1 min-h-0",children:[(0,n.jsx)("div",{className:"px-3 py-2 bg-[#2d2d2d] border-b border-[#404040]",children:(0,n.jsx)("span",{className:"text-xs text-gray-400",children:"⬛ 终端"})}),(0,n.jsx)("div",{ref:k,className:"flex-1 overflow-hidden"}),(0,n.jsxs)("div",{className:"flex items-center gap-2 px-3 py-2 bg-[#2d2d2d] border-t border-[#404040]",children:[(0,n.jsx)("span",{className:"text-xs text-gray-500",children:"$"}),(0,n.jsx)("input",{ref:C,type:"text",value:b,onChange:e=>w(e.target.value),onKeyDown:e=>{"Enter"===e.key&&P()},placeholder:S?"输入命令...":"等待 Shell 启动...",disabled:!S,className:"flex-1 bg-transparent text-sm text-gray-200 placeholder-gray-600 outline-none font-mono disabled:opacity-50"}),(0,n.jsx)("button",{onClick:P,disabled:!S||!b.trim(),className:"px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"执行"})]})]})]}),(0,n.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 bg-[#2d2d2d] border-b border-[#404040]",children:[(0,n.jsx)("span",{className:"text-xs text-gray-400",children:"预览"}),d&&(0,n.jsx)("button",{onClick:D,className:"px-2 py-1 text-xs text-gray-300 hover:text-white hover:bg-[#404040] rounded transition-colors",title:"刷新预览",children:"↻ 刷新"})]}),(0,n.jsx)("div",{className:"flex-1 relative",children:p?(0,n.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,n.jsx)("div",{className:"text-red-500 text-center px-5",children:p})}):d?(0,n.jsx)("iframe",{ref:E,src:d,className:"w-full h-full border-none bg-white"}):(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full gap-4",children:[(0,n.jsx)("div",{className:"w-8 h-8 border-3 border-[#404040] border-t-blue-500 rounded-full animate-spin"}),(0,n.jsx)("div",{className:"text-gray-400",children:r})]})})]})]})]})},{})}))}},s={};function a(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}};return l[e](r,r.exports,a),r.exports}a.m=l,a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e=[],a.O=(t,r,n,l)=>{if(r){l=l||0;for(var s=e.length;s>0&&e[s-1][2]>l;s--)e[s]=e[s-1];e[s]=[r,n,l];return}for(var i=1/0,s=0;s<e.length;s++){for(var[r,n,l]=e[s],o=!0,c=0;c<r.length;c++)(!1&l||i>=l)&&Object.keys(a.O).every(e=>a.O[e](r[c]))?r.splice(c--,1):(o=!1,l<i&&(i=l));if(o){e.splice(s--,1);var d=n();void 0!==d&&(t=d)}}return t},t={153:0,649:0},a.O.j=e=>0===t[e],r=(e,r)=>{var n,l,[s,i,o]=r,c=0;if(s.some(e=>0!==t[e])){for(n in i)a.o(i,n)&&(a.m[n]=i[n]);if(o)var d=o(a)}for(e&&e(r);c<s.length;c++)l=s[c],a.o(t,l)&&t[l]&&t[l][0](),t[l]=0;return a.O(d)},(n=self.webpackChunklark_codesandbox_plugin=self.webpackChunklark_codesandbox_plugin||[]).forEach(r.bind(null,0)),n.push=r.bind(null,n.push.bind(n));var i=a.O(void 0,["783","923","649"],()=>a(596));i=a.O(i)})();