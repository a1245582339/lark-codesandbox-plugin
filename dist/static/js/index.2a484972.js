(()=>{"use strict";var e,t,r,n,l,s={51(e,t,r){var n=r(70),l=r(758),s=r(576),a=r(864),i=r(878),o=r(497);async function c(){let e=new Promise((e,t)=>{setTimeout(()=>t(Error("SDK 初始化超时")),3e3)}),t=o.UV.base.getSelection();return await Promise.race([t,e]),o.UV}async function d(e){let t=await fetch(e);return await t.text()}let u=e=>{var t,r;let{files:s,setFiles:o,isInBitable:c}=e,[u,x]=(0,l.useState)(null),[m,p]=(0,l.useState)(""),[f,h]=(0,l.useState)(!1),[g,b]=(0,l.useState)(null),[v,j]=(0,l.useState)(400),y=(0,l.useRef)(null),N=(0,l.useRef)(null),w=(0,l.useRef)(null),k=(0,l.useRef)(new Map),S=(0,l.useRef)(null),A=(0,l.useRef)(!1);(0,l.useEffect)(()=>{let e=()=>{if(w.current){let e=w.current.getBoundingClientRect();j(Math.max(300,window.innerHeight-e.top-16))}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[m,f]);let E=async e=>{let t=e.target.files;if(!t||0===t.length)return;let r=[];for(let e of(k.current.clear(),Array.from(t))){let t=e.name.toLowerCase();if(t.endsWith(".jsx")||t.endsWith(".tsx")){let t=await e.text(),n=`local-${Date.now()}-${e.name}`;k.current.set(n,t),r.push({name:e.name,url:"",token:n,type:e.type})}}o(r),N.current&&(N.current.value="")},O=function(e){let t=e.filter(e=>"App.tsx"===e.name||"App.jsx"===e.name);if(0===t.length)return{valid:!1,error:"缺少入口文件：请上传 App.tsx 或 App.jsx 文件"};if(t.length>1){let e=t.some(e=>"App.tsx"===e.name),r=t.some(e=>"App.jsx"===e.name);return e&&r?{valid:!1,error:"入口文件冲突：不能同时存在 App.tsx 和 App.jsx，请只保留一个"}:{valid:!1,error:`发现多个入口文件：${t.map(e=>e.name).join(", ")}，请只保留一个`}}return{valid:!0,appFile:t[0]}}(s);(0,l.useEffect)(()=>{if(s.length>0&&O.valid&&O.appFile){let e=O.appFile;((null==u?void 0:u.token)!==e.token||(null==u?void 0:u.url)!==e.url)&&x(e)}else x(null),p("")},[s,O.valid,null==(t=O.appFile)?void 0:t.token,null==(r=O.appFile)?void 0:r.url]);let C=(0,l.useRef)("");return((0,l.useEffect)(()=>{if(!u){C.current="";return}u.token===C.current||(async()=>{try{let e;h(!0),b(null),e=u.token.startsWith("local-")?k.current.get(u.token)||"":await d(u.url),p(e),C.current=u.token}catch(e){b(e instanceof Error?e.message:"加载失败")}finally{h(!1)}})()},[u]),(0,l.useEffect)(()=>()=>{y.current&&!y.current.closed&&y.current.close()},[]),0===s.length)?(0,n.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[(0,n.jsx)("input",{ref:N,type:"file",accept:".tsx,.jsx",onChange:E,className:"hidden"}),c?(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-gray-300 gap-2",children:[(0,n.jsx)("div",{className:"text-5xl mb-2",children:"\uD83D\uDCCE"}),(0,n.jsx)("h3",{className:"text-base font-semibold text-gray-800",children:"请选择附件字段"}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:"选择包含 App.tsx 或 App.jsx 文件的附件单元格"})]}):(0,n.jsxs)("div",{onClick:()=>{var e;return null==(e=N.current)?void 0:e.click()},className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-gray-300 gap-2 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors",children:[(0,n.jsx)("div",{className:"text-5xl mb-2",children:"\uD83D\uDCE4"}),(0,n.jsx)("h3",{className:"text-base font-semibold text-gray-800",children:"点击上传文件"}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:"支持 App.tsx 或 App.jsx 文件"})]})]}):O.valid?(0,n.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[g&&(0,n.jsx)("div",{className:"px-3 py-2.5 bg-red-50 border border-red-200 rounded-md text-sm text-red-600",children:g}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)("button",{onClick:()=>{let e;if(!m||!u)return;y.current&&!y.current.closed&&y.current.close();let t=JSON.stringify({code:m,fileName:u.name,fromParent:!0}),r=(0,i.compressToEncodedURIComponent)(t),n=new URL("./preview.html",window.location.href).href,l=n+"#c="+r;if(l.length<=6e4)A.current=!0,S.current=null,e=l;else{A.current=!1;let r=`preview-${Date.now()}`;S.current=r,localStorage.setItem(r,t),e=n+"#"+r}y.current=window.open(e,"react-preview","width=1200,height=800")},disabled:!m||f,className:"flex-1 py-3 text-base font-medium text-white bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed rounded-lg cursor-pointer transition-colors flex items-center justify-center gap-2",children:f?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"正在加载..."]}):(0,n.jsx)(n.Fragment,{children:"\uD83D\uDE80 在新窗口预览"})}),!c&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("input",{ref:N,type:"file",accept:".tsx,.jsx",onChange:E,className:"hidden"}),(0,n.jsx)("button",{onClick:()=>{var e;return null==(e=N.current)?void 0:e.click()},className:"px-4 py-3 text-base font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg cursor-pointer transition-colors",children:"\uD83D\uDCC2 重新上传"})]})]}),(0,n.jsxs)("div",{className:"px-4 py-3 bg-blue-50 border border-blue-200 rounded-md",children:[(0,n.jsx)("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"使用说明"}),(0,n.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1 list-disc list-inside",children:[(0,n.jsx)("li",{children:"附件中必须包含 App.tsx 或 App.jsx 作为入口"}),(0,n.jsx)("li",{children:"目前只支持单文件组件，不支持文件间引用"}),(0,n.jsx)("li",{children:"请确保额外依赖都在组件顶部通过 import 引入"}),(0,n.jsx)("li",{children:"首次打开需要等待环境初始化（约30秒-1分钟）"})]}),(0,n.jsx)("h4",{className:"text-sm font-medium text-blue-800 mt-3 mb-2",children:"预装依赖"}),(0,n.jsx)("div",{className:"flex flex-wrap gap-1.5",children:["react","react-dom","tailwindcss"].map(e=>(0,n.jsx)("span",{className:"px-2 py-0.5 text-xs font-mono bg-blue-100 text-blue-700 rounded",children:e},e))}),(0,n.jsx)("p",{className:"text-xs text-blue-600 mt-2",children:"其他依赖会根据代码中的 import 自动安装"})]}),m&&!f&&(0,n.jsxs)("div",{ref:w,className:"bg-white rounded-lg border border-gray-200 overflow-hidden flex",children:[(0,n.jsxs)("div",{className:"w-48 bg-[#252526] border-r border-[#3c3c3c] flex flex-col",children:[(0,n.jsx)("div",{className:"px-3 py-2 text-xs text-gray-400 uppercase tracking-wide",children:"文件"}),(0,n.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-[#37373d] text-white text-sm cursor-pointer",children:[(0,n.jsx)("span",{className:"text-yellow-400",children:"\uD83D\uDCC4"}),(0,n.jsx)("span",{children:null==u?void 0:u.name})]})]}),(0,n.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,n.jsx)("div",{className:"flex items-center px-3 py-1.5 bg-[#2d2d2d] border-b border-[#3c3c3c]",children:(0,n.jsx)("span",{className:"text-sm text-gray-300",children:null==u?void 0:u.name})}),(0,n.jsx)(a.Ay,{height:`${v}px`,language:(null==u?void 0:u.name.endsWith(".tsx"))?"typescript":"javascript",theme:"vs-dark",value:m,onChange:e=>{let t=e||"";p(t);if(y.current&&!y.current.closed&&u&&y.current.postMessage({type:"code-update",code:t,fileName:u.name},"*"),u){if(A.current&&y.current&&!y.current.closed){let e=JSON.stringify({code:t,fileName:u.name,fromParent:!0}),r=(0,i.compressToEncodedURIComponent)(e);(new URL("./preview.html",window.location.href).href+"#c="+r).length<=6e4&&(y.current.location.hash="#c="+r)}else if(S.current){let e=JSON.stringify({code:t,fileName:u.name});localStorage.setItem(S.current,e)}}},beforeMount:e=>{e.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSemanticValidation:!0,noSyntaxValidation:!0}),e.languages.typescript.javascriptDefaults.setDiagnosticsOptions({noSemanticValidation:!0,noSyntaxValidation:!0})},options:{minimap:{enabled:!1},fontSize:13,lineNumbers:"on",scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:2,find:{addExtraSpaceOnTop:!1,autoFindInSelection:"never",seedSearchStringFromSelection:"selection"}},onMount:e=>{e.addCommand(2084,()=>{var t;null==(t=e.getAction("actions.find"))||t.run()})}})]})]})]}):(0,n.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-red-300 gap-2",children:[(0,n.jsx)("div",{className:"text-5xl mb-2",children:"⚠️"}),(0,n.jsx)("h3",{className:"text-base font-semibold text-red-600",children:"文件验证失败"}),(0,n.jsx)("p",{className:"text-sm text-red-500 max-w-[280px]",children:O.error})]}),(0,n.jsxs)("div",{className:"px-4 py-3 bg-gray-50 border border-gray-200 rounded-md",children:[(0,n.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"当前附件文件："}),(0,n.jsx)("ul",{className:"text-sm text-gray-600 space-y-1",children:s.map(e=>(0,n.jsx)("li",{className:"flex items-center gap-2",children:(0,n.jsxs)("span",{className:"App.tsx"===e.name||"App.jsx"===e.name?"text-red-500 font-medium":"",children:["\uD83D\uDCC4 ",e.name]})},e.token))})]}),(0,n.jsxs)("div",{className:"px-4 py-3 bg-blue-50 border border-blue-200 rounded-md",children:[(0,n.jsx)("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"文件要求"}),(0,n.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1 list-disc list-inside",children:[(0,n.jsx)("li",{children:"必须包含一个 App.tsx 或 App.jsx 作为入口文件"}),(0,n.jsx)("li",{children:"不能同时存在 App.tsx 和 App.jsx"}),(0,n.jsx)("li",{children:"入口文件必须导出一个 React 组件"})]})]})]})},x=document.getElementById("root");x&&s.createRoot(x).render((0,n.jsx)(l.StrictMode,{children:(0,n.jsx)(()=>{let[e,t]=(0,l.useState)([]),[r,s]=(0,l.useState)(!1),[a,i]=(0,l.useState)(!0);return((0,l.useEffect)(()=>{let e=e=>{(e.ctrlKey||e.metaKey)&&"f"===e.key&&e.preventDefault()};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[]),(0,l.useEffect)(()=>{(async()=>{try{await c(),s(!0),i(!0),function(e){let t=null,r="",n=null;async function l(e,t,r){try{let n=await o.UV.base.getTableById(e),l=await n.getFieldById(r),s=await l.getType();if(17!==s)return[];let a=await l.getValue(t);if(!a||0===a.length)return[];let i=a.filter(e=>{let t=e.name.toLowerCase();return t.endsWith(".jsx")||t.endsWith(".tsx")});if(0===i.length)return[];let c=await l.getAttachmentUrls(t),d=new Map;return c.forEach((e,t)=>{a[t]&&d.set(a[t].token,e)}),i.map(e=>({name:e.name,url:d.get(e.token)||"",token:e.token,type:e.type}))}catch(e){return console.error("[Bitable] Error reading attachment field:",e),[]}}function s(e){return e.map(e=>`${e.token}:${e.name}`).sort().join("|")}async function a(){if(!t)return;let{tableId:n,recordId:a,fieldId:i}=t,o=await l(n,a,i),c=s(o);c!==r&&(console.log("[Bitable] Files changed:",o.map(e=>e.name)),r=c,e(o))}function i(){n&&(clearInterval(n),n=null)}o.UV.base.onSelectionChange(async o=>{let{fieldId:c,recordId:d,tableId:u}=o.data;if(console.log("[Bitable] Selection changed:",{fieldId:c,recordId:d,tableId:u}),!c||!d||!u){console.log("[Bitable] Missing selection data, clearing"),t=null,r="",i(),e([]);return}t={tableId:u,recordId:d,fieldId:c};let x=await l(u,d,c),m=s(x);console.log("[Bitable] Files:",x.map(e=>e.name)),r=m,e(x),i(),n=setInterval(a,2e3)})}(e=>{console.log("[App] Received files:",e.map(e=>e.name)),t(e)})}catch(e){console.error("Failed to initialize Bitable SDK:",e),i(!1),s(!0)}})()},[]),r)?(0,n.jsxs)("div",{className:"flex flex-col min-h-screen p-4 bg-gray-100 font-sans",children:[(0,n.jsx)("header",{className:"mb-4",children:(0,n.jsx)("p",{className:"text-sm text-gray-500",children:a?"选择附件字段中的 JSX/TSX 文件进行实时预览":"上传 JSX/TSX 文件进行实时预览"})}),(0,n.jsx)("main",{className:"flex-1 flex flex-col",children:(0,n.jsx)(u,{files:e,setFiles:t,isInBitable:a})})]}):(0,n.jsx)("div",{className:"flex flex-col min-h-screen p-4 bg-gray-100 font-sans",children:(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] gap-4",children:[(0,n.jsx)("div",{className:"w-8 h-8 border-3 border-gray-200 border-t-blue-500 rounded-full animate-spin"}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:"正在初始化..."})]})})},{})}))}},a={};function i(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={id:e,loaded:!1,exports:{}};return s[e](r,r.exports,i),r.loaded=!0,r.exports}i.m=s,i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce((t,r)=>(i.f[r](e,t),t),[])),i.u=e=>"static/js/async/"+e+".925ccc17.js",i.miniCssF=e=>""+e+".css",i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},i.l=function(t,r,n,l){if(e[t])return void e[t].push(r);if(void 0!==n)for(var s,a,o=document.getElementsByTagName("script"),c=0;c<o.length;c++){var d=o[c];if(d.getAttribute("src")==t||d.getAttribute("data-rspack")=="lark-codesandbox-plugin:"+n){s=d;break}}s||(a=!0,(s=document.createElement("script")).timeout=120,i.nc&&s.setAttribute("nonce",i.nc),s.setAttribute("data-rspack","lark-codesandbox-plugin:"+n),s.src=t),e[t]=[r];var u=function(r,n){s.onerror=s.onload=null,clearTimeout(x);var l=e[t];if(delete e[t],s.parentNode&&s.parentNode.removeChild(s),l&&l.forEach(function(e){return e(n)}),r)return r(n)},x=setTimeout(u.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=u.bind(null,s.onerror),s.onload=u.bind(null,s.onload),a&&document.head.appendChild(s)},i.r=e=>{"u">typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),i.nc=void 0,t=[],i.O=(e,r,n,l)=>{if(r){l=l||0;for(var s=t.length;s>0&&t[s-1][2]>l;s--)t[s]=t[s-1];t[s]=[r,n,l];return}for(var a=1/0,s=0;s<t.length;s++){for(var[r,n,l]=t[s],o=!0,c=0;c<r.length;c++)(!1&l||a>=l)&&Object.keys(i.O).every(e=>i.O[e](r[c]))?r.splice(c--,1):(o=!1,l<a&&(a=l));if(o){t.splice(s--,1);var d=n();void 0!==d&&(e=d)}}return e},i.p="./",r={410:0,649:0},i.f.j=function(e,t){var n=i.o(r,e)?r[e]:void 0;if(0!==n)if(n)t.push(n[2]);else if(649!=e){var l=new Promise((t,l)=>n=r[e]=[t,l]);t.push(n[2]=l);var s=i.p+i.u(e),a=Error();i.l(s,function(t){if(i.o(r,e)&&(0!==(n=r[e])&&(r[e]=void 0),n)){var l=t&&("load"===t.type?"missing":t.type),s=t&&t.target&&t.target.src;a.message="Loading chunk "+e+" failed.\n("+l+": "+s+")",a.name="ChunkLoadError",a.type=l,a.request=s,n[1](a)}},"chunk-"+e,e)}else r[e]=0},i.O.j=e=>0===r[e],n=(e,t)=>{var n,l,[s,a,o]=t,c=0;if(s.some(e=>0!==r[e])){for(n in a)i.o(a,n)&&(i.m[n]=a[n]);if(o)var d=o(i)}for(e&&e(t);c<s.length;c++)l=s[c],i.o(r,l)&&r[l]&&r[l][0](),r[l]=0;return i.O(d)},(l=self.webpackChunklark_codesandbox_plugin=self.webpackChunklark_codesandbox_plugin||[]).forEach(n.bind(null,0)),l.push=n.bind(null,l.push.bind(l));var o=i.O(void 0,["783","239","649"],()=>i(51));o=i.O(o)})();