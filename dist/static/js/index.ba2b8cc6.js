(()=>{"use strict";var e,t,r,n,s,l={51(e,t,r){var n=r(70),s=r(758),l=r(576),a=r(864),i=r(878);async function o(){let e=new Promise((e,t)=>{setTimeout(()=>t(Error("SDK 初始化超时")),3e3)}),t=i.UV.base.getSelection();return await Promise.race([t,e]),i.UV}async function c(e){let t=await fetch(e);return await t.text()}let d=e=>{var t,r;let{files:l,setFiles:i,isInBitable:o}=e,[d,u]=(0,s.useState)(null),[x,m]=(0,s.useState)(""),[p,f]=(0,s.useState)(!1),[h,g]=(0,s.useState)(null),[b,v]=(0,s.useState)(400),j=(0,s.useRef)(null),y=(0,s.useRef)(null),N=(0,s.useRef)(null),w=(0,s.useRef)(new Map),k=(0,s.useRef)(null);(0,s.useEffect)(()=>{let e=()=>{if(N.current){let e=N.current.getBoundingClientRect();v(Math.max(300,window.innerHeight-e.top-16))}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[x,p]);let S=async e=>{let t=e.target.files;if(!t||0===t.length)return;let r=[];for(let e of(w.current.clear(),Array.from(t))){let t=e.name.toLowerCase();if(t.endsWith(".jsx")||t.endsWith(".tsx")){let t=await e.text(),n=`local-${Date.now()}-${e.name}`;w.current.set(n,t),r.push({name:e.name,url:"",token:n,type:e.type})}}i(r),y.current&&(y.current.value="")},A=function(e){let t=e.filter(e=>"App.tsx"===e.name||"App.jsx"===e.name);if(0===t.length)return{valid:!1,error:"缺少入口文件：请上传 App.tsx 或 App.jsx 文件"};if(t.length>1){let e=t.some(e=>"App.tsx"===e.name),r=t.some(e=>"App.jsx"===e.name);return e&&r?{valid:!1,error:"入口文件冲突：不能同时存在 App.tsx 和 App.jsx，请只保留一个"}:{valid:!1,error:`发现多个入口文件：${t.map(e=>e.name).join(", ")}，请只保留一个`}}return{valid:!0,appFile:t[0]}}(l);(0,s.useEffect)(()=>{if(l.length>0&&A.valid&&A.appFile){let e=A.appFile;((null==d?void 0:d.token)!==e.token||(null==d?void 0:d.url)!==e.url)&&u(e)}else u(null),m("")},[l,A.valid,null==(t=A.appFile)?void 0:t.token,null==(r=A.appFile)?void 0:r.url]);let E=(0,s.useRef)("");return((0,s.useEffect)(()=>{if(!d){E.current="";return}d.token===E.current||(async()=>{try{let e;f(!0),g(null),e=d.token.startsWith("local-")?w.current.get(d.token)||"":await c(d.url),m(e),E.current=d.token}catch(e){g(e instanceof Error?e.message:"加载失败")}finally{f(!1)}})()},[d]),(0,s.useEffect)(()=>()=>{j.current&&!j.current.closed&&j.current.close()},[]),0===l.length)?(0,n.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[(0,n.jsx)("input",{ref:y,type:"file",accept:".tsx,.jsx",onChange:S,className:"hidden"}),o?(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-gray-300 gap-2",children:[(0,n.jsx)("div",{className:"text-5xl mb-2",children:"\uD83D\uDCCE"}),(0,n.jsx)("h3",{className:"text-base font-semibold text-gray-800",children:"请选择附件字段"}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:"选择包含 App.tsx 或 App.jsx 文件的附件单元格"})]}):(0,n.jsxs)("div",{onClick:()=>{var e;return null==(e=y.current)?void 0:e.click()},className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-gray-300 gap-2 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors",children:[(0,n.jsx)("div",{className:"text-5xl mb-2",children:"\uD83D\uDCE4"}),(0,n.jsx)("h3",{className:"text-base font-semibold text-gray-800",children:"点击上传文件"}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:"支持 App.tsx 或 App.jsx 文件"})]})]}):A.valid?(0,n.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[h&&(0,n.jsx)("div",{className:"px-3 py-2.5 bg-red-50 border border-red-200 rounded-md text-sm text-red-600",children:h}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)("button",{onClick:()=>{if(!x||!d)return;j.current&&!j.current.closed&&j.current.close();let e=`preview-${Date.now()}`;k.current=e;let t=JSON.stringify({code:x,fileName:d.name,fromParent:!0});localStorage.setItem(e,t);let r=new URL("./preview.html",window.location.href).href+"#"+e;j.current=window.open(r,"react-preview","width=1200,height=800")},disabled:!x||p,className:"flex-1 py-3 text-base font-medium text-white bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed rounded-lg cursor-pointer transition-colors flex items-center justify-center gap-2",children:p?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"正在加载..."]}):(0,n.jsx)(n.Fragment,{children:"\uD83D\uDE80 在新窗口预览"})}),!o&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("input",{ref:y,type:"file",accept:".tsx,.jsx",onChange:S,className:"hidden"}),(0,n.jsx)("button",{onClick:()=>{var e;return null==(e=y.current)?void 0:e.click()},className:"px-4 py-3 text-base font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg cursor-pointer transition-colors",children:"\uD83D\uDCC2 重新上传"})]})]}),(0,n.jsxs)("div",{className:"px-4 py-3 bg-blue-50 border border-blue-200 rounded-md",children:[(0,n.jsx)("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"使用说明"}),(0,n.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1 list-disc list-inside",children:[(0,n.jsx)("li",{children:"附件中必须包含 App.tsx 或 App.jsx 作为入口"}),(0,n.jsx)("li",{children:"目前只支持单文件组件，不支持文件间引用"}),(0,n.jsx)("li",{children:"请确保额外依赖都在组件顶部通过 import 引入"}),(0,n.jsx)("li",{children:"首次打开需要等待环境初始化（约30秒）"})]}),(0,n.jsx)("h4",{className:"text-sm font-medium text-blue-800 mt-3 mb-2",children:"预装依赖"}),(0,n.jsx)("div",{className:"flex flex-wrap gap-1.5",children:["react","react-dom","tailwindcss"].map(e=>(0,n.jsx)("span",{className:"px-2 py-0.5 text-xs font-mono bg-blue-100 text-blue-700 rounded",children:e},e))}),(0,n.jsx)("p",{className:"text-xs text-blue-600 mt-2",children:"其他依赖会根据代码中的 import 自动安装"})]}),x&&!p&&(0,n.jsxs)("div",{ref:N,className:"bg-white rounded-lg border border-gray-200 overflow-hidden flex",children:[(0,n.jsxs)("div",{className:"w-48 bg-[#252526] border-r border-[#3c3c3c] flex flex-col",children:[(0,n.jsx)("div",{className:"px-3 py-2 text-xs text-gray-400 uppercase tracking-wide",children:"文件"}),(0,n.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-[#37373d] text-white text-sm cursor-pointer",children:[(0,n.jsx)("span",{className:"text-yellow-400",children:"\uD83D\uDCC4"}),(0,n.jsx)("span",{children:null==d?void 0:d.name})]})]}),(0,n.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,n.jsx)("div",{className:"flex items-center px-3 py-1.5 bg-[#2d2d2d] border-b border-[#3c3c3c]",children:(0,n.jsx)("span",{className:"text-sm text-gray-300",children:null==d?void 0:d.name})}),(0,n.jsx)(a.Ay,{height:`${b}px`,language:(null==d?void 0:d.name.endsWith(".tsx"))?"typescript":"javascript",theme:"vs-dark",value:x,onChange:e=>{let t=e||"";m(t);if(j.current&&!j.current.closed&&d&&j.current.postMessage({type:"code-update",code:t,fileName:d.name},"*"),k.current&&d){let e=JSON.stringify({code:t,fileName:d.name});localStorage.setItem(k.current,e)}},beforeMount:e=>{e.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSemanticValidation:!0,noSyntaxValidation:!0}),e.languages.typescript.javascriptDefaults.setDiagnosticsOptions({noSemanticValidation:!0,noSyntaxValidation:!0})},options:{minimap:{enabled:!1},fontSize:13,lineNumbers:"on",scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:2,find:{addExtraSpaceOnTop:!1,autoFindInSelection:"never",seedSearchStringFromSelection:"selection"}},onMount:e=>{e.addCommand(2084,()=>{var t;null==(t=e.getAction("actions.find"))||t.run()})}})]})]})]}):(0,n.jsxs)("div",{className:"flex flex-col gap-3 flex-1",children:[(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] text-center bg-white rounded-lg border border-dashed border-red-300 gap-2",children:[(0,n.jsx)("div",{className:"text-5xl mb-2",children:"⚠️"}),(0,n.jsx)("h3",{className:"text-base font-semibold text-red-600",children:"文件验证失败"}),(0,n.jsx)("p",{className:"text-sm text-red-500 max-w-[280px]",children:A.error})]}),(0,n.jsxs)("div",{className:"px-4 py-3 bg-gray-50 border border-gray-200 rounded-md",children:[(0,n.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"当前附件文件："}),(0,n.jsx)("ul",{className:"text-sm text-gray-600 space-y-1",children:l.map(e=>(0,n.jsx)("li",{className:"flex items-center gap-2",children:(0,n.jsxs)("span",{className:"App.tsx"===e.name||"App.jsx"===e.name?"text-red-500 font-medium":"",children:["\uD83D\uDCC4 ",e.name]})},e.token))})]}),(0,n.jsxs)("div",{className:"px-4 py-3 bg-blue-50 border border-blue-200 rounded-md",children:[(0,n.jsx)("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"文件要求"}),(0,n.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1 list-disc list-inside",children:[(0,n.jsx)("li",{children:"必须包含一个 App.tsx 或 App.jsx 作为入口文件"}),(0,n.jsx)("li",{children:"不能同时存在 App.tsx 和 App.jsx"}),(0,n.jsx)("li",{children:"入口文件必须导出一个 React 组件"})]})]})]})},u=document.getElementById("root");u&&l.createRoot(u).render((0,n.jsx)(s.StrictMode,{children:(0,n.jsx)(()=>{let[e,t]=(0,s.useState)([]),[r,l]=(0,s.useState)(!1),[a,c]=(0,s.useState)(!0);return((0,s.useEffect)(()=>{let e=e=>{(e.ctrlKey||e.metaKey)&&"f"===e.key&&e.preventDefault()};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[]),(0,s.useEffect)(()=>{(async()=>{try{await o(),l(!0),c(!0),function(e){let t=null,r="",n=null;async function s(e,t,r){try{let n=await i.UV.base.getTableById(e),s=await n.getFieldById(r),l=await s.getType();if(17!==l)return[];let a=await s.getValue(t);if(!a||0===a.length)return[];let o=a.filter(e=>{let t=e.name.toLowerCase();return t.endsWith(".jsx")||t.endsWith(".tsx")});if(0===o.length)return[];let c=await s.getAttachmentUrls(t),d=new Map;return c.forEach((e,t)=>{a[t]&&d.set(a[t].token,e)}),o.map(e=>({name:e.name,url:d.get(e.token)||"",token:e.token,type:e.type}))}catch(e){return console.error("[Bitable] Error reading attachment field:",e),[]}}function l(e){return e.map(e=>`${e.token}:${e.name}`).sort().join("|")}async function a(){if(!t)return;let{tableId:n,recordId:a,fieldId:i}=t,o=await s(n,a,i),c=l(o);c!==r&&(console.log("[Bitable] Files changed:",o.map(e=>e.name)),r=c,e(o))}function o(){n&&(clearInterval(n),n=null)}i.UV.base.onSelectionChange(async i=>{let{fieldId:c,recordId:d,tableId:u}=i.data;if(console.log("[Bitable] Selection changed:",{fieldId:c,recordId:d,tableId:u}),!c||!d||!u){console.log("[Bitable] Missing selection data, clearing"),t=null,r="",o(),e([]);return}t={tableId:u,recordId:d,fieldId:c};let x=await s(u,d,c),m=l(x);console.log("[Bitable] Files:",x.map(e=>e.name)),r=m,e(x),o(),n=setInterval(a,2e3)})}(e=>{console.log("[App] Received files:",e.map(e=>e.name)),t(e)})}catch(e){console.error("Failed to initialize Bitable SDK:",e),c(!1),l(!0)}})()},[]),r)?(0,n.jsxs)("div",{className:"flex flex-col min-h-screen p-4 bg-gray-100 font-sans",children:[(0,n.jsx)("header",{className:"mb-4",children:(0,n.jsx)("p",{className:"text-sm text-gray-500",children:a?"选择附件字段中的 JSX/TSX 文件进行实时预览":"上传 JSX/TSX 文件进行实时预览"})}),(0,n.jsx)("main",{className:"flex-1 flex flex-col",children:(0,n.jsx)(d,{files:e,setFiles:t,isInBitable:a})})]}):(0,n.jsx)("div",{className:"flex flex-col min-h-screen p-4 bg-gray-100 font-sans",children:(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-[300px] gap-4",children:[(0,n.jsx)("div",{className:"w-8 h-8 border-3 border-gray-200 border-t-blue-500 rounded-full animate-spin"}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:"正在初始化..."})]})})},{})}))}},a={};function i(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={exports:{}};return l[e](r,r.exports,i),r.exports}i.m=l,i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce((t,r)=>(i.f[r](e,t),t),[])),i.u=e=>"static/js/async/"+e+".925ccc17.js",i.miniCssF=e=>""+e+".css",i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},i.l=function(t,r,n,s){if(e[t])return void e[t].push(r);if(void 0!==n)for(var l,a,o=document.getElementsByTagName("script"),c=0;c<o.length;c++){var d=o[c];if(d.getAttribute("src")==t||d.getAttribute("data-rspack")=="lark-codesandbox-plugin:"+n){l=d;break}}l||(a=!0,(l=document.createElement("script")).timeout=120,i.nc&&l.setAttribute("nonce",i.nc),l.setAttribute("data-rspack","lark-codesandbox-plugin:"+n),l.src=t),e[t]=[r];var u=function(r,n){l.onerror=l.onload=null,clearTimeout(x);var s=e[t];if(delete e[t],l.parentNode&&l.parentNode.removeChild(l),s&&s.forEach(function(e){return e(n)}),r)return r(n)},x=setTimeout(u.bind(null,void 0,{type:"timeout",target:l}),12e4);l.onerror=u.bind(null,l.onerror),l.onload=u.bind(null,l.onload),a&&document.head.appendChild(l)},i.r=e=>{"u">typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.nc=void 0,t=[],i.O=(e,r,n,s)=>{if(r){s=s||0;for(var l=t.length;l>0&&t[l-1][2]>s;l--)t[l]=t[l-1];t[l]=[r,n,s];return}for(var a=1/0,l=0;l<t.length;l++){for(var[r,n,s]=t[l],o=!0,c=0;c<r.length;c++)(!1&s||a>=s)&&Object.keys(i.O).every(e=>i.O[e](r[c]))?r.splice(c--,1):(o=!1,s<a&&(a=s));if(o){t.splice(l--,1);var d=n();void 0!==d&&(e=d)}}return e},i.p="./",r={410:0,649:0},i.f.j=function(e,t){var n=i.o(r,e)?r[e]:void 0;if(0!==n)if(n)t.push(n[2]);else if(649!=e){var s=new Promise((t,s)=>n=r[e]=[t,s]);t.push(n[2]=s);var l=i.p+i.u(e),a=Error();i.l(l,function(t){if(i.o(r,e)&&(0!==(n=r[e])&&(r[e]=void 0),n)){var s=t&&("load"===t.type?"missing":t.type),l=t&&t.target&&t.target.src;a.message="Loading chunk "+e+" failed.\n("+s+": "+l+")",a.name="ChunkLoadError",a.type=s,a.request=l,n[1](a)}},"chunk-"+e,e)}else r[e]=0},i.O.j=e=>0===r[e],n=(e,t)=>{var n,s,[l,a,o]=t,c=0;if(l.some(e=>0!==r[e])){for(n in a)i.o(a,n)&&(i.m[n]=a[n]);if(o)var d=o(i)}for(e&&e(t);c<l.length;c++)s=l[c],i.o(r,s)&&r[s]&&r[s][0](),r[s]=0;return i.O(d)},(s=self.webpackChunklark_codesandbox_plugin=self.webpackChunklark_codesandbox_plugin||[]).forEach(n.bind(null,0)),s.push=n.bind(null,s.push.bind(s));var o=i.O(void 0,["783","140","649"],()=>i(51));o=i.O(o)})();